<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>hhçš„å…±äº«æ–‡ä»¶ - å…¨å±€æœç´¢ç‰ˆ</title>
    <style>
        :root { 
            --primary-color: #2563eb; 
            --bg-color: #f8fafc; 
            --card-bg: #ffffff;
            --text-main: #1e293b;
            --text-muted: #64748b;
            --border-color: #e2e8f0;
        }
        body { font-family: -apple-system, system-ui, sans-serif; background: var(--bg-color); margin: 0; padding: 20px; color: var(--text-main); }
        .container { max-width: 1000px; margin: 0 auto; }
        
        h1 { font-size: 1.5rem; margin: 0 0 20px 5px; display: flex; align-items: center; gap: 10px; }

        /* åŠŸèƒ½åŒº */
        .function-area { 
            background: var(--card-bg); 
            padding: 20px; 
            border-radius: 12px; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
        }

        .nav-row { display: flex; align-items: center; gap: 12px; margin-bottom: 15px; }
        .nav-controls { display: flex; gap: 6px; }
        .nav-btn {
            width: 36px; height: 36px; display: flex; align-items: center; justify-content: center;
            background: white; border: 1px solid var(--border-color); border-radius: 8px;
            cursor: pointer; color: var(--text-muted); font-size: 1.2rem; transition: 0.2s;
        }
        .nav-btn:hover:not(:disabled) { border-color: var(--primary-color); color: var(--primary-color); background: #eff6ff; }
        .nav-btn:disabled { opacity: 0.3; cursor: not-allowed; }

        .breadcrumb {
            flex: 1; display: flex; flex-wrap: wrap; align-items: center; padding: 0 16px;
            background: #f1f5f9; border-radius: 8px; font-size: 0.95rem; height: 36px; overflow: hidden;
        }
        .breadcrumb-item { display: flex; align-items: center; white-space: nowrap; }
        .breadcrumb-item + .breadcrumb-item::before { content: "â€º"; padding: 0 8px; color: #cbd5e1; font-size: 1.2rem; }
        .breadcrumb-item a { color: var(--primary-color); text-decoration: none; font-weight: 500; }


        /* æ–‡ä»¶åˆ—è¡¨åŒº */
        .file-list-container {
            background: var(--card-bg);
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border: 1px solid var(--border-color);
            overflow: hidden;
        }
        .file-list { list-style: none; padding: 0; margin: 0; }
        .file-item { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 16px 20px; border-bottom: 1px solid #f1f5f9; transition: 0.2s;
        }
        .file-item:hover { background: #f8fafc; }
        
        .file-info { display: flex; flex-direction: column; overflow: hidden; margin-right: 15px; flex: 1; }
        .file-name { font-weight: 500; color: var(--text-main); font-size: 1rem; margin-bottom: 2px; word-break: break-all; }
        
        /* è·¯å¾„æ˜¾ç¤ºæ ·å¼ */
        .file-path { font-size: 0.75rem; color: #94a3b8; display: flex; align-items: center; gap: 4px; }
        .file-path span { background: #f1f5f9; padding: 1px 6px; border-radius: 4px; }

        .file-meta { font-size: 0.8rem; color: var(--text-muted); margin-top: 4px; }

        .actions { display: flex; gap: 8px; flex-shrink: 0; }
        .btn { padding: 7px 16px; border-radius: 6px; text-decoration: none; font-size: 0.85rem; font-weight: 600; border: 1px solid transparent; cursor: pointer; }
        .btn-preview { background: #ecfdf5; color: #059669; border-color: #d1fae5; }
        .btn-download { background: #eff6ff; color: #2563eb; border-color: #dbeafe; }
        .btn-folder { background: #fff7ed; color: #c2410c; border-color: #ffedd5; }

        .loading { text-align: center; color: var(--text-muted); padding: 50px; }
        .highlight { color: #e11d48; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ“ æˆ‘çš„å…±äº«æ–‡ä»¶</h1>
    
    <div class="function-area">
        <div class="nav-row">
            <div class="nav-controls">
                <button class="nav-btn" onclick="history.back()">â†</button>
                <button class="nav-btn" onclick="history.forward()">â†’</button>
            </div>
            <nav id="breadcrumb" class="breadcrumb"></nav>
        </div>
        
        <div class="search-row">
            <span class="search-icon">ğŸ”</span>
            <input type="text" id="search-input" placeholder="è¾“å…¥å…³é”®å­—è¿›è¡Œå…¨åº“æœç´¢..." onkeyup="handleSearch(event)">
            <div id="search-status">æ­£åœ¨æ·±åº¦æœç´¢ä¸­...</div>
        </div>
    </div>

    <div class="file-list-container">
        <ul id="file-list" class="file-list">
            <div class="loading">åŠ è½½ä¸­...</div>
        </ul>
    </div>
</div>

<script>
    const API_DOMAIN = 'https://api.steveh1110.com';
    const NAS_DOMAIN = 'https://nas.steveh1110.com';
    let allDataCache = []; // ç”¨äºå­˜å‚¨è·å–åˆ°çš„æ‰€æœ‰æ–‡ä»¶æ•°æ®

    // åˆå§‹åŠ è½½
    async function init() {
        const urlParams = new URLSearchParams(window.location.search);
        const prefix = urlParams.get('prefix') || '';
        renderPage(prefix);
    }

    async function renderPage(prefix) {
        const listElement = document.getElementById('file-list');
        const breadcrumbElement = document.getElementById('breadcrumb');
        listElement.innerHTML = '<div class="loading">æ­£åœ¨è¯»å–ç›®å½•...</div>';
        
        renderBreadcrumb(prefix, breadcrumbElement);

        try {
            const response = await fetch(`${API_DOMAIN}?prefix=${encodeURIComponent(prefix)}`);
            const data = await response.json();
            renderList(data, prefix);
        } catch (e) {
            listElement.innerHTML = `<div class="loading">åŠ è½½å¤±è´¥: ${e.message}</div>`;
        }
    }

    // æ ¸å¿ƒæ¸²æŸ“å‡½æ•°
    function renderList(data, currentPrefix, isSearch = false) {
        const listElement = document.getElementById('file-list');
        listElement.innerHTML = '';

        // æ¸²æŸ“æ–‡ä»¶å¤¹ (æœç´¢æ¨¡å¼ä¸‹ä¸æ˜¾ç¤ºæ–‡ä»¶å¤¹ï¼Œåªæ˜¾ç¤ºåŒ¹é…çš„æ–‡ä»¶)
        if (!isSearch && data.delimitedPrefixes) {
            data.delimitedPrefixes.forEach(folder => {
                const folderName = folder.split('/').filter(Boolean).pop();
                const li = document.createElement('li');
                li.className = 'file-item';
                li.innerHTML = `
                    <div class="file-info"><span class="file-name">ğŸ“ ${folderName}</span></div>
                    <div class="actions"><a href="?prefix=${encodeURIComponent(folder)}" class="btn btn-folder">æ‰“å¼€</a></div>
                `;
                listElement.appendChild(li);
            });
        }

        // æ¸²æŸ“æ–‡ä»¶
        const objects = isSearch ? data : data.objects;
        if (objects) {
            objects.forEach(file => {
                if (file.key === currentPrefix) return;
                const fileName = file.key.split('/').pop();
                const filePath = file.key.substring(0, file.key.lastIndexOf('/') + 1);
                
                const isPdf = file.key.toLowerCase().endsWith('.pdf');
                const previewUrl = `${API_DOMAIN}/${encodeURIComponent(file.key)}`;
                const downloadUrl = `${NAS_DOMAIN}/${encodeURIComponent(file.key)}`;

                const li = document.createElement('li');
                li.className = 'file-item';
                li.innerHTML = `
                    <div class="file-info">
                        <span class="file-name">ğŸ“„ ${fileName}</span>
                        ${isSearch ? `<div class="file-path">ğŸ“ ä½ç½®: <span>${filePath || 'æ ¹ç›®å½•'}</span></div>` : ''}
                        <span class="file-meta">${(file.size / 1024 / 1024).toFixed(2)} MB</span>
                    </div>
                    <div class="actions">
                        ${isPdf ? `<a href="${previewUrl}" target="_blank" class="btn btn-preview">é¢„è§ˆ</a>` : ''}
                        <a href="${downloadUrl}" download class="btn btn-download">ä¸‹è½½</a>
                    </div>
                `;
                listElement.appendChild(li);
            });
        }
        
        if (listElement.innerHTML === '') {
            listElement.innerHTML = '<div class="loading">æœªæ‰¾åˆ°ç›¸å…³å†…å®¹</div>';
        }
    }

    function renderBreadcrumb(prefix, container) {
        container.innerHTML = '';
        const rootSpan = document.createElement('span');
        rootSpan.className = 'breadcrumb-item';
        rootSpan.innerHTML = `<a href="?prefix=">ğŸ  å…¨éƒ¨æ–‡ä»¶</a>`;
        container.appendChild(rootSpan);

        if (prefix) {
            const parts = prefix.split('/').filter(Boolean);
            let cumulativePath = '';
            parts.forEach((part, index) => {
                cumulativePath += part + '/';
                const span = document.createElement('span');
                span.className = 'breadcrumb-item';
                if (index === parts.length - 1) {
                    span.innerText = part;
                } else {
                    span.innerHTML = `<a href="?prefix=${encodeURIComponent(cumulativePath)}">${part}</a>`;
                }
                container.appendChild(span);
            });
        }
    }

    window.addEventListener('DOMContentLoaded', init);
    // ç›‘å¬åé€€/å‰è¿›äº‹ä»¶é‡æ–°åŠ è½½
    window.addEventListener('popstate', init);
</script>
</body>
</html>