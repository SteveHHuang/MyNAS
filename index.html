<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>hhçš„å…±äº«æ–‡ä»¶</title>
    <style>
        :root { 
            --primary-color: #2563eb; 
            --bg-color: #f1f5f9; 
            --text-main: #334155;
            --text-muted: #64748b;
        }
        body { font-family: -apple-system, system-ui, sans-serif; background: var(--bg-color); margin: 0; padding: 15px; }
        .container { max-width: 900px; margin: 0 auto; background: white; padding: 25px; border-radius: 16px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
        
        h1 { font-size: 1.5rem; color: #0f172a; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; }

        
        .breadcrumb {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            padding: 12px 16px;
            margin-bottom: 20px;
            background: #f8fafc;
            border-radius: 8px;
            font-size: 0.9rem;
            border: 1px solid #e2e8f0;
        }
        .breadcrumb-item { display: flex; align-items: center; }
        .breadcrumb-item + .breadcrumb-item::before {
            content: "â€º";
            padding: 0 8px;
            color: #cbd5e1;
            font-size: 1.2rem;
        }
        .breadcrumb-item a {
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 500;
        }
        .breadcrumb-item a:hover { text-decoration: underline; }
        .breadcrumb-item.active { color: var(--text-muted); font-weight: normal; }

        /* åˆ—è¡¨æ ·å¼ */
        .file-list { list-style: none; padding: 0; margin: 0; }
        .file-item { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 14px; 
            border-bottom: 1px solid #f1f5f9; 
            transition: all 0.2s; 
            border-radius: 8px; 
        }
        .file-item:hover { background: #f8fafc; transform: translateX(4px); }
        .file-info { display: flex; flex-direction: column; overflow: hidden; margin-right: 10px; }
        .file-name { font-weight: 500; color: var(--text-main); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .file-size { font-size: 0.75rem; color: #94a3b8; margin-top: 4px; }

        /* æŒ‰é’®æ ·å¼ */
        .actions { display: flex; gap: 10px; flex-shrink: 0; }
        .btn { 
            padding: 6px 14px; 
            border-radius: 8px; 
            text-decoration: none; 
            font-size: 0.85rem; 
            font-weight: 600; 
            transition: all 0.2s; 
            border: 1px solid transparent; 
        }
        .btn-preview { background: #ecfdf5; color: #059669; border-color: #10b981; }
        .btn-download { background: #eff6ff; color: #2563eb; border-color: #3b82f6; }
        .btn-folder { background: #fff7ed; color: #c2410c; border-color: #fb923c; }
        .btn:hover { opacity: 0.8; filter: brightness(0.95); }

        .loading { text-align: center; color: var(--text-muted); padding: 40px; }
        .error-msg { color: #ef4444; text-align: center; padding: 20px; background: #fef2f2; border-radius: 8px; }
    </style>
</head>
<body>

<div class="container">
    <h1 id="title">ğŸ“ æˆ‘çš„å…±äº«æ–‡ä»¶</h1>
    <ul id="file-list" class="file-list">
        <div class="loading">æ­£åœ¨æ‰«æä»“åº“ï¼Œè¯·ç¨å€™...</div>
    </ul>
</div>

<script>
    // ======= æ ¸å¿ƒåŸŸåé…ç½® =======
    const API_DOMAIN = 'https://api.steveh1110.com'; // ç”¨äºè·å–åˆ—è¡¨åŠ PDF é¢„è§ˆ
    const NAS_DOMAIN = 'https://nas.steveh1110.com'; // ç”¨äºæ™®é€šæ–‡ä»¶ä¸‹è½½

    async function fetchFiles() {
        const urlParams = new URLSearchParams(window.location.search);
        const prefix = urlParams.get('prefix') || '';
        const listElement = document.getElementById('file-list');
        const breadcrumbElement = document.getElementById('breadcrumb');

        try {
            // 1. ç”Ÿæˆé¢åŒ…å±‘å¯¼èˆª
            renderBreadcrumb(prefix, breadcrumbElement);

            // 2. ä» API è·å–æ•°æ®
            const response = await fetch(`${API_DOMAIN}?prefix=${encodeURIComponent(prefix)}`);
            if (!response.ok) throw new Error('æ— æ³•è¿æ¥åˆ° APIï¼Œè¯·æ£€æŸ¥ Worker çŠ¶æ€');
            
            const data = await response.json();
            listElement.innerHTML = '';

            // 3. æ¸²æŸ“æ–‡ä»¶å¤¹
            if (data.delimitedPrefixes) {
                data.delimitedPrefixes.forEach(folder => {
                    const folderName = folder.split('/').filter(Boolean).pop();
                    const li = document.createElement('li');
                    li.className = 'file-item';
                    li.innerHTML = `
                        <div class="file-info"><span class="file-name">ğŸ“ ${folderName}</span></div>
                        <div class="actions"><a href="?prefix=${encodeURIComponent(folder)}" class="btn btn-folder">æ‰“å¼€</a></div>
                    `;
                    listElement.appendChild(li);
                });
            }

            // 4. æ¸²æŸ“æ–‡ä»¶
            if (data.objects) {
                data.objects.forEach(file => {
                    if (file.key === prefix) return; 

                    const fileName = file.key.split('/').pop();
                    if (!fileName) return;

                    const isPdf = file.key.toLowerCase().endsWith('.pdf');
                    // é¢„è§ˆèµ° API (Worker), ä¸‹è½½èµ° NAS (R2 ç›´è¿)
                    const previewUrl = `${API_DOMAIN}/${encodeURIComponent(file.key)}`;
                    const downloadUrl = `${NAS_DOMAIN}/${encodeURIComponent(file.key)}`;

                    const li = document.createElement('li');
                    li.className = 'file-item';
                    li.innerHTML = `
                        <div class="file-info">
                            <span class="file-name">ğŸ“„ ${fileName}</span>
                            <span class="file-size">${(file.size / 1024 / 1024).toFixed(2)} MB</span>
                        </div>
                        <div class="actions">
                            ${isPdf ? `<a href="${previewUrl}" target="_blank" class="btn btn-preview">é¢„è§ˆ</a>` : ''}
                            <a href="${downloadUrl}" download class="btn btn-download">ä¸‹è½½</a>
                        </div>
                    `;
                    listElement.appendChild(li);
                });
            }

            if (listElement.innerHTML === '') {
                listElement.innerHTML = '<div class="loading">è¯¥æ–‡ä»¶å¤¹ä¸‹æ²¡æœ‰æ–‡ä»¶</div>';
            }

        } catch (error) {
            listElement.innerHTML = `<div class="error-msg">âŒ åŠ è½½å¤±è´¥: ${error.message}</div>`;
        }
    }

    // é¢åŒ…å±‘æ¸²æŸ“å‡½æ•°
    function renderBreadcrumb(prefix, container) {
        container.innerHTML = '';
        
        // æ ¹ç›®å½•èµ·ç‚¹
        const rootSpan = document.createElement('span');
        rootSpan.className = 'breadcrumb-item';
        rootSpan.innerHTML = `<a href="?prefix=">ğŸ  å…¨éƒ¨æ–‡ä»¶</a>`;
        container.appendChild(rootSpan);

        if (prefix) {
            const parts = prefix.split('/').filter(Boolean);
            let cumulativePath = '';
            
            parts.forEach((part, index) => {
                cumulativePath += part + '/';
                const span = document.createElement('span');
                span.className = 'breadcrumb-item';
                
                if (index === parts.length - 1) {
                    span.classList.add('active');
                    span.innerText = part;
                } else {
                    span.innerHTML = `<a href="?prefix=${encodeURIComponent(cumulativePath)}">${part}</a>`;
                }
                container.appendChild(span);
            });
        }
    }

    fetchFiles();
</script>

</body>
</html>